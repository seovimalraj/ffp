version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: ffp-api
    environment:
      NODE_ENV: production
      PORT: 3001
      
      # External Supabase Database
      DATABASE_URL: postgresql://postgres:uekrlbczst9ib354dpwiztqpjluswjcf@ffp-supabase-0913e9-31-97-103-26.traefik.me:5432/postgres
      
      # External Redis
      REDIS_URL: redis://default:8ysnsuqspjdjzpza@ffp-redis-o6ngzu:6379
      REDIS_HOST: ffp-redis-o6ngzu
      REDIS_PORT: 6379
      REDIS_PASSWORD: 8ysnsuqspjdjzpza
      
      # Supabase Configuration
      SUPABASE_URL: https://ffp-supabase-0913e9-31-97-103-26.traefik.me
      SUPABASE_SERVICE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NjgyNDQ0MDUsImV4cCI6MTg5MzQ1NjAwMCwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlzcyI6InN1cGFiYXNlIn0.EEGk9NAKrzO670rKAeFJbol-7jUaqHfHW1kmfvuQnV8
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NjgyNDQ0MDUsImV4cCI6MTg5MzQ1NjAwMCwicm9sZSI6ImFub24iLCJpc3MiOiJzdXBhYmFzZSJ9.WzLzSu9G1JUkVAG13sdt1Aa4MPyvWDUccpvJL-anLTw
      SUPABASE_STORAGE_BUCKET: cad-files
      
      # JWT Configuration
      JWT_SECRET: cigjaz10fpxv76bvmzber5tjnmc8semu
      JWT_EXPIRES_IN: 7d
      
      # Service URLs
      CAD_SERVICE_URL: http://cad-service:10001
      APP_URL: https://ffp-web.frigate.ai
      ALLOWED_ORIGINS: https://ffp-web.frigate.ai,https://ffp-api.frigate.ai,https://ffp-cad.frigate.ai,https://dokploy.frigate.ai
      
      # File Upload Settings
      MAX_FILE_SIZE: 100MB
      ALLOWED_FILE_TYPES: .step,.stp,.stl,.iges,.igs,.obj
    expose:
      - "3001"
    networks:
      - ffp-network
    restart: unless-stopped

  cad-service:
    build:
      context: .
      dockerfile: apps/cad-service/Dockerfile
    container_name: ffp-cad-service
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 10001
      
      # External Supabase Database
      DATABASE_URL: postgresql://postgres:uekrlbczst9ib354dpwiztqpjluswjcf@ffp-supabase-0913e9-31-97-103-26.traefik.me:5432/postgres
      
      # External Redis
      REDIS_URL: redis://default:8ysnsuqspjdjzpza@ffp-redis-o6ngzu:6379
      
      # Processing Settings
      MAX_FILE_SIZE: 100MB
      TEMP_DIR: /tmp/cad-uploads
      PROCESSING_TIMEOUT: 300
      
      # Security
      API_KEY: cigjaz10fpxv76bvmzber5tjnmc8semu
      CORS_ORIGINS: https://ffp-web.frigate.ai,https://ffp-api.frigate.ai,https://ffp-cad.frigate.ai,https://dokploy.frigate.ai
    expose:
      - "10001"
    networks:
      - ffp-network
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://ffp-api.frigate.ai
    container_name: ffp-web
    environment:
      NODE_ENV: production
      PORT: 3000
      NEXT_PUBLIC_API_URL: https://ffp-api.frigate.ai
    expose:
      - "3000"
    networks:
      - ffp-network
    restart: unless-stopped

networks:
  ffp-network:
    driver: bridge
