# FFP - Nginx Configuration for all frigate.ai subdomains

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# --- HTTP -> HTTPS redirect for all FFP subdomains
server {
    listen 80;
    listen [::]:80;
    server_name app.frigate.ai ffp-web.frigate.ai ffp-api.frigate.ai ffp-cad.frigate.ai ffp-redis.frigate.ai supabase.frigate.ai;
    return 301 https://$host$request_uri;
}

# --- app.frigate.ai (HTTPS)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.frigate.ai;

    ssl_certificate /etc/ssl/server.crt;
    ssl_certificate_key /etc/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    client_max_body_size 200M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    # Next.js static assets
    location ^~ /_next/ {
        proxy_pass http://web:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # Storage/File Upload endpoints (NestJS - must come before /api/)
    location /storage/ {
        proxy_pass http://api:4001/storage/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_request_buffering off;
        proxy_buffering off;
        client_max_body_size 200M;
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
    }

    # NextAuth endpoints (Next.js - must come before /api/)
    location /api/auth/ {
        proxy_pass http://web:3000/api/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;
    }

    # Profile endpoint (Next.js - must come before /api/)
    location /api/profile {
        proxy_pass http://web:3000/api/profile;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;
    }

    # API Service (NestJS backend)
    location /api/ {
        proxy_pass http://api:4001/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
        
        # Handle OPTIONS requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }

    # CAD Service (Python)
    location /cad/ {
        proxy_pass http://cad-service:10001/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header 'Access-Control-Allow-Origin' '*' always;
        proxy_read_timeout 300s;
        client_max_body_size 200M;
    }

    # Web application (Next.js frontend)
    location / {
        proxy_pass http://web:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# --- ffp-web.frigate.ai (HTTPS) - Direct access to Next.js frontend
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ffp-web.frigate.ai;

    ssl_certificate /etc/ssl/server.crt;
    ssl_certificate_key /etc/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    client_max_body_size 200M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    location / {
        proxy_pass http://web:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# --- ffp-api.frigate.ai (HTTPS) - Direct access to NestJS API
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ffp-api.frigate.ai;

    ssl_certificate /etc/ssl/server.crt;
    ssl_certificate_key /etc/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    client_max_body_size 200M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    location / {
        proxy_pass http://api:4001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
        
        # Handle OPTIONS requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
}

# --- ffp-cad.frigate.ai (HTTPS) - Direct access to CAD Service
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ffp-cad.frigate.ai;

    ssl_certificate /etc/ssl/server.crt;
    ssl_certificate_key /etc/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    client_max_body_size 200M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    location / {
        proxy_pass http://cad-service:10001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header 'Access-Control-Allow-Origin' '*' always;
        proxy_read_timeout 300s;
    }
}

# --- ffp-redis.frigate.ai (HTTPS) - Redis web interface/monitoring
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ffp-redis.frigate.ai;

    ssl_certificate /etc/ssl/server.crt;
    ssl_certificate_key /etc/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        # Redis doesn't have HTTP interface, return info page
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Redis Service Info</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .info { background: #f0f0f0; padding: 20px; border-radius: 8px; }
        .warning { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }
        code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>FFP Redis Service</h1>
    <div class="info">
        <h2>Service Information</h2>
        <p><strong>Service:</strong> Redis Cache (v7.x)</p>
        <p><strong>Status:</strong> Running</p>
        <p><strong>Internal Address:</strong> redis:6379</p>
        <p><strong>Purpose:</strong> Caching layer for FFP application</p>
    </div>
    <div class="warning">
        <strong>Note:</strong> Redis is a TCP service and does not have a web interface. 
        Access is restricted to internal FFP services only.
    </div>
    <h3>Connection Details (Internal Only)</h3>
    <ul>
        <li><strong>Host:</strong> <code>redis</code></li>
        <li><strong>Port:</strong> <code>6379</code></li>
        <li><strong>URL:</strong> <code>redis://redis:6379</code></li>
    </ul>
    <h3>Connected Services</h3>
    <ul>
        <li>FFP API (NestJS) - <a href="https://ffp-api.frigate.ai">ffp-api.frigate.ai</a></li>
        <li>CAD Service (Python) - <a href="https://ffp-cad.frigate.ai">ffp-cad.frigate.ai</a></li>
    </ul>
</body>
</html>';
        add_header Content-Type text/html;
    }
}

# --- supabase.frigate.ai (HTTP -> HTTPS redirect)
server {
    listen 80;
    listen [::]:80;
    server_name supabase.frigate.ai;
    return 301 https://$host$request_uri;
}

# --- supabase.frigate.ai (HTTPS)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name supabase.frigate.ai;

    ssl_certificate /etc/ssl/server.crt;
    ssl_certificate_key /etc/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    client_max_body_size 200M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    # HTTP Basic Auth for Supabase Studio
    auth_basic "Supabase Studio Access";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # Proxy API paths to Supabase Kong gateway (no auth required for API)
    location ~ ^/(auth|rest|realtime|storage|functions|pg|graphql)/ {
        auth_basic off;
        proxy_pass http://host.docker.internal:54321;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy root and studio UI to Supabase Studio
    location / {
        proxy_pass http://host.docker.internal:54323;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
